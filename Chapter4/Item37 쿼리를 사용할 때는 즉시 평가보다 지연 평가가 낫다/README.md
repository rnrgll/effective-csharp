# 37\. 쿼리를 사용할 때는 즉시 평가보다 지연 평가가 낫다

## 37.1 LINQ 쿼리는 실행이 아니라 정의(동작 설명서)다

```csharp
var query = numbers.Where(n => n >10);
```

*   LINQ 쿼리를 작성하는 행위는 데이터를 즉시 가져오는 것이 아니라, **데이터를 어떻게 생성하고 처리할지에 대한 절차를 정의하는 것**이다.
*   쿼리는 실제로 순회(`foreach`, `ToList()` 등)가 발생하기 전까지 실행되지 않는다.
*   람다 표현식 역시 즉시 실행되는 코드가 아니라 **향후 실행될 코드 조각**을 의미한다. ⇒ LINQ에서는 코드 자체를 데이터처럼 다뤄야 한다.

## 37.2 쿼리 특징

### 37.2.1 지연 평가(Lazy Evaluation)

*   쿼리를 정의할 때는 실행하지 않고, 실제로 값을 필요로 할 때(순회할 때), **매번 순회할 때마다 다시 실행한다.**

```csharp
var sequence = Generate(10, () => DateTime.Now);
```

*   `Generate()`는 `yield return`을 사용 → **이터레이터**
*   `sequence`는 결과(값 그 자체)를 들고 있는 게 아니라 ‘**DateTime.Now를 호출하는 방법’(시퀀스 내 개별 요소를 생성하는 방법)을 들고 있다.**
*   쿼리는 결과를 저장하지 않고, **순회할 때마다 다시 실행되기 때문에,** 매번 새로운 값을 생성할 수 있다.

### 37.2.2 쿼리 합성과 실행 파이프라인

LINQ 쿼리는 이전 쿼리의 결과를 저장해두고 가공하는 방식이 아니라, **여러 쿼리를 하나의 실행 파이프라인으로 합성**한다.

*   이전 쿼리의 로직이 다시 실행되고
*   그 결과에 추가 연산이 적용된다

```csharp
var sequence1 = Generate(10, () => DateTime.Now);
var sequence2 =
fromvalue in sequence1
selectvalue.ToUniversalTime();

```

*   `sequence1` 이 실행 결과를 저장해두고, `sequence2` 가 이를 가공하는 것이 아니다.
    
*   두 쿼리가 합성되어 하나의 실행 파이프라인이 된다.
    
    `sequence2` 를 순회하는 순간 `sequence1` 의 generator가 실행된다.
    

### 37.2.3 무한 시퀀스

*   필요할 때 실행하는 지연 평가 덕분에 LINQ는 **이론적으로 무한한 시퀀스**를 다룰 수 있다.
*   사실상 무한 시퀀스임에도 **전체 시퀀스를 생성하지 않고 필요한 순간까지만 생성**하기 때문에 안전하고 효율적이다.
    *   사전에 전체 시퀀스를 생성하는 것이 아니라 **빠르고 메모리에 안전하다**

#### 전체 시퀀스를 요구하는 연산자

일부 쿼리 표현식의 경우 결과를 얻기 위해 반드시 **<span class="fontColorRed">전체 시퀀스가 준비되어야하는 경우</span>**가 있다.

다음 연산자들은 결과를 계산하기 위해 **모든 요소를 검사해야 한다**:

*   `where`
*   `orderby`
*   `Max`, `Min`
*   `Count`, `Sum`, `Average`

이러한 연산자를 무한 시퀀스에 적용하면 쿼리가 종료되지 않거나 심각한 성능 문제가 발생할 수 있다.

```csharp
var query =	from n in AllNumbers()
			where n < 10
			select n;
```

→ `where`는 **조건에 맞는 모든 요소를 찾기 위해** 전체 시퀀스를 끝까지 검색해야 한다.

#### **쿼리 순서와 성능**

쿼리 연산자의 **작성 순서가 성능에 직접적인 영향을 준다.**

**시퀀스를 필터링하는 쿼리 메서드는 다른 쿼리보다 먼저 수행하면 성능 개선이 가능하다.**

→ 선행 단계에서 컬렉션의 요소를 필터링하여 개수를 줄일 수 있다!

```csharp
// 느림
from pin products
orderby p.UnitsInStockdescending // 전체에 대해서 정렬 후
where p.UnitsInStock >100 // 전체에 대해서 비교해서 필터링
select p;
```

```csharp
// 빠름
from pin products
where p.UnitsInStock >100 // 전체에 대해서 비교 후 필터링
orderby p.UnitsInStockdescending // 필터링만 정렬
select p;
```

### 37.2.4 즉시 평가

즉시 평가는 쿼리를 정의하는 즉시 실행하여 **결과를 컬렉션에 저장하는 방식**이다.

*   `ToList()`
*   `ToArray()`

```csharp
var cached = query.ToList(); // 이 시점에 쿼리를 즉시 실행하여 결과를 저장한다.
```

#### 즉시평가가 필요한 상황

1.  **특정 시점의 데이터 스냅샷이 필요할 때 :** 이후 원본 데이터가 바뀌어도 결과 고정된다.
2.  **동일한 결과를 여러 번 사용할 때 :** 매번 다시 계산하는 비용 제거할 수 있다.
